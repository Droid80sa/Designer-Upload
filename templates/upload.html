{% extends "base.html" %}
{% block title %}Upload Artwork – Hot Ink{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Hot Ink Logo" style="max-width: 180px;">
    <h2 class="mt-3 text-white">Upload Your Artwork</h2>
    <p class="text-muted upload-note">Files are securely sent to your selected designer. Please fill in your details below.</p>
  </div>

  <form id="uploadForm" class="p-4 rounded shadow">
    <div class="form-group mb-3">
      <label class="text-white">Designer</label>
      <select class="form-control" name="designer" required>
        {% for d in designers %}
        <option value="{{ d.name }}">{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group mb-3">
      <label class="text-white">Your Name</label>
      <input type="text" class="form-control" name="client_name" required>
    </div>
    <div class="form-group mb-3">
      <label class="text-white">Email</label>
      <input type="email" class="form-control" name="email" required>
    </div>
    <div class="form-group mb-3">
      <label class="text-white">Contact</label>
      <input type="text" class="form-control" name="contact" required>
    </div>
    <div class="form-group mb-3">
      <label class="text-white">Instructions</label>
      <textarea class="form-control" name="instructions" rows="3"></textarea>
    </div>
  </form>

  <!-- Dropzone -->
  <div id="dropzone" class="dropzone mt-3 border border-info rounded"></div>

  <button id="startUploadBtn" type="button" class="btn btn-primary mt-3">Start Upload</button>

  <!-- Progress Bar -->
  <div class="progress mt-4" style="height: 20px; display: none;" id="uploadProgress">
    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
         role="progressbar" style="width: 0%;" id="uploadProgressBar">
      0%
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
Dropzone.autoDiscover = false;

const progressWrapper = document.getElementById("uploadProgress");
const progressBar = document.getElementById("uploadProgressBar");

const myDropzone = new Dropzone("#dropzone", {
  url: "/upload",
  autoProcessQueue: false,
  uploadMultiple: true,
  parallelUploads: 10,
  maxFilesize: 1024, // MB
  addRemoveLinks: true,
  init: function() {
    const dz = this;

    dz.on("sendingmultiple", () => {
      progressWrapper.style.display = "block";
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";
    });

    dz.on("uploadprogress", (file, progress) => {
      const pct = Math.round(progress);
      progressBar.style.width = pct + "%";
      progressBar.textContent = pct + "%";
    });

    dz.on("successmultiple", () => {
      Swal.fire('✅ Upload Complete!', 'Your designer will respond shortly.', 'success')
        .then(() => {
          window.location.reload();
        });
    });

    dz.on("error", () => {
      Swal.fire('⚠️ Upload Error', 'Something went wrong. Try again or contact support.', 'error');
      progressWrapper.style.display = "none";
    });

    dz.on("queuecomplete", () => {
      progressWrapper.style.display = "none";
    });

    document.querySelector("#uploadForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const form = e.target;
      if (!form.reportValidity()) {
        return;
      }

      const formData = new FormData(form);
      dz.options.params = Object.fromEntries(formData);
      dz.processQueue();
    });
  }
});

document.getElementById("startUploadBtn").addEventListener("click", function(e) {
  e.preventDefault();
  document.querySelector("#uploadForm").dispatchEvent(new Event('submit'));
});
</script>
{% endblock %}
